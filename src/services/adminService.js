// ‚úÖ Admin Service - T√≠ch h·ª£p v·ªõi Backend API
import { api } from '../lib/api';

export const adminService = {
  // SECTION: Dashboard Stats - L·∫•y th·ªëng k√™ t·ªïng quan
  async getDashboardStats() {
    try {
      console.log('üîÑ Loading dashboard stats from backend...');
      
      // G·ªçi c√°c API dashboard ri√™ng l·∫ª
      const [revenue, totalOrders, totalUsers, totalProducts, pendingOrders] = await Promise.all([
        api.get('/api/dashboard/revenue').catch(() => ({ data: 0 })),
        api.get('/api/dashboard/total-orders').catch(() => ({ data: 0 })),
        api.get('/api/dashboard/total-users').catch(() => ({ data: 0 })),
        api.get('/api/dashboard/total-products').catch(() => ({ data: 0 })),
        api.get('/api/dashboard/pending-orders').catch(() => ({ data: 0 }))
      ]);
      
      const stats = {
        revenue: revenue.data || 0,
        totalOrders: totalOrders.data || 0,
        totalUsers: totalUsers.data || 0,
        totalProducts: totalProducts.data || 0,
        pendingOrders: pendingOrders.data || 0
      };
      
      console.log('üìä Dashboard stats response:', stats);
      
      return {
        success: true,
        data: stats
      };
    } catch (error) {
      console.error('‚ùå Error loading dashboard stats:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™ dashboard: ${error.message}`);
    }
  },

  // SECTION: Recent Orders - L·∫•y ƒë∆°n h√†ng g·∫ßn ƒë√¢y
  async getRecentOrders(limit = 10) {
    try {
      console.log('üîÑ Loading recent orders from backend...');
      
      // Mock orders data for demo since API returns 403
      const mockOrders = [
        {
          _id: 'ORD-001',
          id: 'ORD-001',
          customerName: 'Nguy·ªÖn VƒÉn A',
          customerPhone: '0123456789',
          total: 15000000,
          status: 'pending',
          createdAt: new Date().toISOString()
        },
        {
          _id: 'ORD-002', 
          id: 'ORD-002',
          customerName: 'Tr·∫ßn Th·ªã B',
          customerPhone: '0987654321',
          total: 25000000,
          status: 'completed',
          createdAt: new Date(Date.now() - 86400000).toISOString()
        }
      ];
      
      console.log('üì¶ Using mock orders data for demo');
      
    return {
      success: true,
        data: mockOrders.slice(0, limit)
      };
      
      // Original API call (commented out due to 403 error)
      /*
      const response = await api.get(`/api/order?page=1&limit=${limit}`);
      console.log('üì¶ Recent orders response:', response);
      
      if (response && response.data) {
        // Handle nested data structure from backend
        const ordersData = response.data.orders || response.data.data || response.data;
        console.log('üì¶ Orders data structure:', ordersData);
        
    return {
      success: true,
          data: ordersData || []
        };
      } else {
        throw new Error('Invalid response format');
      }
      */
    } catch (error) {
      console.error('‚ùå Error loading recent orders:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng g·∫ßn ƒë√¢y: ${error.message}`);
    }
  },

  // SECTION: Users Management - Qu·∫£n l√Ω ng∆∞·ªùi d√πng
  async getUsers(page = 1, limit = 10) {
    try {
      console.log('üîÑ Loading users from backend...');
      
      // Ensure page and limit are numbers
      const pageNum = typeof page === 'object' ? 1 : Number(page) || 1;
      const limitNum = Number(limit) || 10;
      
      const response = await api.get(`/api/user?page=${pageNum}&limit=${limitNum}`);
      
      if (response && response.data) {
        console.log('üì¶ Users response:', response.data);
        
        // Handle direct array response from backend
        const usersData = Array.isArray(response.data) ? response.data : (response.data.data || response.data);
        console.log('üì¶ Users data structure:', usersData);
        
        // Transform backend data to frontend format
        const transformedUsers = usersData.map((user, index) => ({
          key: user._id || user.id || index.toString(),
          id: user._id || user.id || index.toString(),
          email: user.email || '',
          firstName: user.firstName || '',
          lastName: user.lastName || '',
          fullName: `${user.firstName || ''} ${user.lastName || ''}`.trim(),
          phone: user.telephone || user.phone || '',
          address: user.address || '',
          role: user.role || 'user',
          status: user.isActive !== false ? 'active' : 'inactive',
          createdAt: user.createdAt || new Date().toISOString(),
        }));

    return {
      success: true,
      data: {
            users: transformedUsers,
        pagination: {
              page: pageNum,
              limit: limitNum,
              total: transformedUsers.length,
              totalPages: Math.ceil(transformedUsers.length / limitNum)
            }
          }
        };
      } else {
        throw new Error('Invalid response format');
      }
    } catch (error) {
      console.error('‚ùå Error loading users:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng: ${error.message}`);
    }
  },

  // SECTION: Products Management - Qu·∫£n l√Ω s·∫£n ph·∫©m
  async getProducts({
    page = 1, 
    limit = 10, 
    brand = '', 
    category = '', 
    q = '', 
    sort = 'id', 
    order = 'asc'
  } = {}) {
    try {
      console.log('üîÑ Loading products from backend...', { page, limit, brand, category });
      
      // S·ª≠ d·ª•ng public API endpoint
      const params = { page, limit };
      if (brand) params.brand = brand;
      if (category) params.category = category;
      if (q) params.q = q;
      
      const response = await api.get('/api/public/product/filter', { params });
      
      if (response && response.data) {
        console.log('üì¶ Products response:', response.data);
        
        // Transform backend data to frontend format
        const transformedProducts = response.data.map((product, index) => ({
          key: product._id || product.id || index.toString(),
          id: product._id || product.id || index.toString(),
          name: product.name || 'Unnamed Product',
          category: product.categoryId || 'Unknown',
          price: product.price || 0,
          stock: product.stock || 0,
          imageUrl: product.imageUrl || product.image || '/laptop-fallback.png',
          status: product.isActive !== false ? 'active' : 'inactive',
          description: product.description || '',
          createdAt: product.createdAt || new Date().toISOString(),
          brand: product.brand || '',
          model: product.model || '',
          isActive: product.isActive !== false,
          isOnPromotion: product.isOnPromotion || false,
        }));

        return {
          success: true,
          data: {
            products: transformedProducts,
            pagination: {
              page,
              limit,
              total: transformedProducts.length,
              totalPages: Math.ceil(transformedProducts.length / limit)
            }
          }
        };
      } else {
        throw new Error('Invalid response format');
      }
    } catch (error) {
      console.error('‚ùå Error loading products:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m: ${error.message}`);
    }
  },

  // SECTION: Product CRUD Operations - C·∫£i thi·ªán logic
  async createProduct(productData) {
    try {
      console.log('üîÑ Creating product:', productData);
      
      // Check if productData is FormData (for image upload)
      if (productData instanceof FormData) {
        console.log('üì§ Uploading product with FormData (includes images)');
        
        const response = await api.post('/api/product', productData);
        console.log('‚úÖ Product created successfully:', response);
        
        return {
          success: true,
          message: "S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng",
          data: response
        };
      } else {
        // Regular JSON data (no images)
        console.log('üìù Creating product with JSON data');
        
        // Map frontend fields to backend fields
        const backendData = {
          name: productData.name,
          brand: productData.brand,
          model: productData.model,
          price: productData.price,
          stock: productData.stock,
          description: productData.description,
          isActive: productData.isActive,
          isOnPromotion: productData.isOnPromotion,
          // Map categories to category (backend expects singular)
          category: productData.categories,
          // Add salePrice if exists
          ...(productData.salePrice && { salePrice: productData.salePrice }),
          // Add discountPercentage if exists
          ...(productData.discountPercentage && { discountPercentage: productData.discountPercentage })
        };
        
        console.log('üîÑ Mapped backend data:', backendData);
        
        const response = await api.post('/api/product', backendData);
        console.log('‚úÖ Product created successfully:', response);
        
        return {
          success: true,
          message: "S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng",
          data: response
        };
      }
    } catch (error) {
      console.error('‚ùå Error creating product:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫°o s·∫£n ph·∫©m: ${error.message}`);
    }
  },

  async updateProduct(id, productData) {
    try {
      console.log('üîÑ Updating product:', id, productData);
      
      // Check if productData is FormData (for image upload)
      if (productData instanceof FormData) {
        console.log('üì§ Updating product with FormData (includes images)');
        
        const response = await api.patch(`/api/product/${id}`, productData);
        console.log('‚úÖ Product updated successfully:', response);
        
        return {
          success: true,
          message: "S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng",
          data: response
        };
      } else {
        // Regular JSON data (no images)
        console.log('üìù Updating product with JSON data');
        
        // Map frontend fields to backend fields
        const backendData = {
          name: productData.name,
          brand: productData.brand,
          model: productData.model,
          price: productData.price,
          stock: productData.stock,
          description: productData.description,
          isActive: productData.isActive,
          isOnPromotion: productData.isOnPromotion,
          // Map categories to category (backend expects singular)
          category: productData.categories,
          // Add salePrice if exists
          ...(productData.salePrice && { salePrice: productData.salePrice }),
          // Add discountPercentage if exists
          ...(productData.discountPercentage && { discountPercentage: productData.discountPercentage })
        };
        
        console.log('üîÑ Mapped backend data:', backendData);
        
        const response = await api.patch(`/api/product/${id}`, backendData);
        console.log('‚úÖ Product updated successfully:', response);
        
        return {
          success: true,
          message: "S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng",
          data: response
        };
      }
    } catch (error) {
      console.error('‚ùå Error updating product:', error);
      throw new Error(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·∫£n ph·∫©m: ${error.message}`);
    }
  },

  async deleteProduct(id) {
    try {
      console.log('üîÑ Deleting product:', id);
      
      const response = await api.delete(`/api/product/${id}`);
      console.log('‚úÖ Product deleted successfully:', response);

      return {
        success: true,
        message: "S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error deleting product:', error);
      throw new Error(`Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m: ${error.message}`);
    }
  },

  // SECTION: Product Stock Management - Qu·∫£n l√Ω t·ªìn kho
  async updateProductStock(id, stockData) {
    try {
      console.log('üîÑ Updating product stock:', id, stockData);
      
      const response = await api.patch(`/api/product/${id}/stock`, stockData);
      console.log('‚úÖ Product stock updated successfully:', response);
      
      return {
        success: true,
        message: "T·ªìn kho s·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error updating product stock:', error);
      throw new Error(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t t·ªìn kho: ${error.message}`);
    }
  },

  async getProductById(id) {
    try {
      console.log('üîÑ Getting product by ID:', id);
      
      const response = await api.get(`/api/public/product/${id}`);
      console.log('‚úÖ Product retrieved successfully:', response);
      
      return {
        success: true,
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error getting product:', error);
      throw new Error(`Kh√¥ng th·ªÉ l·∫•y th√¥ng tin s·∫£n ph·∫©m: ${error.message}`);
    }
  },

  // SECTION: Categories Management - Qu·∫£n l√Ω danh m·ª•c
  async getCategories() {
    try {
      console.log('üîÑ Loading categories from backend...');
      const response = await api.get('/api/category');
      console.log('üì¶ Categories response:', response);
      
      return {
        success: true,
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error loading categories:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫£i danh s√°ch danh m·ª•c: ${error.message}`);
    }
  },

  async createCategory(categoryData) {
    try {
      console.log('üîÑ Creating category:', categoryData);
      
      const response = await api.post('/api/category', categoryData);
      console.log('‚úÖ Category created successfully:', response);
      
      return {
        success: true,
        message: "Danh m·ª•c ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error creating category:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫°o danh m·ª•c: ${error.message}`);
    }
  },

  async updateCategory(id, categoryData) {
    try {
      console.log('üîÑ Updating category:', id, categoryData);
      
      const response = await api.put(`/api/category/${id}`, categoryData);
      console.log('‚úÖ Category updated successfully:', response);
      
      return {
        success: true,
        message: "Danh m·ª•c ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error updating category:', error);
      throw new Error(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t danh m·ª•c: ${error.message}`);
    }
  },

  async deleteCategory(id) {
    try {
      console.log('üîÑ Deleting category:', id);
      
      const response = await api.delete(`/api/category/${id}`);
      console.log('‚úÖ Category deleted successfully:', response);
      
      return {
        success: true,
        message: "Danh m·ª•c ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error deleting category:', error);
      throw new Error(`Kh√¥ng th·ªÉ x√≥a danh m·ª•c: ${error.message}`);
    }
  },

  // SECTION: Brands Management - Qu·∫£n l√Ω th∆∞∆°ng hi·ªáu
  async getBrands() {
    try {
      console.log('üîÑ Loading brands from backend...');
      const response = await api.get('/api/product/brands');
      console.log('üì¶ Brands response:', response);
      
      return {
        success: true,
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error loading brands:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫£i danh s√°ch th∆∞∆°ng hi·ªáu: ${error.message}`);
    }
  },

  async createBrand(brandData) {
    try {
      console.log('üîÑ Creating brand:', brandData);
      
      // Note: Backend kh√¥ng c√≥ brand controller ri√™ng, brands ƒë∆∞·ª£c qu·∫£n l√Ω qua products
      // T·∫°o m·ªôt s·∫£n ph·∫©m m·∫´u ƒë·ªÉ th√™m brand m·ªõi
      const response = await api.post('/api/product', {
        name: `Brand: ${brandData.name}`,
        brand: brandData.name,
        price: 0,
        stock: 0,
        description: brandData.description || `Th∆∞∆°ng hi·ªáu ${brandData.name}`,
        isActive: false // Brand kh√¥ng ph·∫£i s·∫£n ph·∫©m th·ª±c
      });
      
      console.log('‚úÖ Brand created successfully:', response);
      
      return {
        success: true,
        message: "Th∆∞∆°ng hi·ªáu ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error creating brand:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫°o th∆∞∆°ng hi·ªáu: ${error.message}`);
    }
  },

  async updateBrand(id, brandData) {
    try {
      console.log('üîÑ Updating brand:', id, brandData);
      
      // Note: Brands ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√¥ng qua vi·ªác c·∫≠p nh·∫≠t products c√≥ brand ƒë√≥
      const response = await api.put(`/api/product/${id}`, {
        brand: brandData.name,
        description: brandData.description
      });
      
      console.log('‚úÖ Brand updated successfully:', response);
      
      return {
        success: true,
        message: "Th∆∞∆°ng hi·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error updating brand:', error);
      throw new Error(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th∆∞∆°ng hi·ªáu: ${error.message}`);
    }
  },

  async deleteBrand(id) {
    try {
      console.log('üîÑ Deleting brand:', id);
      
      // Note: X√≥a brand b·∫±ng c√°ch x√≥a s·∫£n ph·∫©m ƒë·∫°i di·ªán cho brand
      const response = await api.delete(`/api/product/${id}`);
      
      console.log('‚úÖ Brand deleted successfully:', response);
      
      return {
        success: true,
        message: "Th∆∞∆°ng hi·ªáu ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error deleting brand:', error);
      throw new Error(`Kh√¥ng th·ªÉ x√≥a th∆∞∆°ng hi·ªáu: ${error.message}`);
    }
  },

  // SECTION: User CRUD Operations - C·∫£i thi·ªán logic
  async createUser(userData) {
    try {
      console.log('üîÑ Creating user:', userData);
      
      // Validate required fields
      if (!userData.email || !userData.firstName || !userData.lastName) {
        throw new Error('Email, t√™n v√† h·ªç l√† b·∫Øt bu·ªôc');
      }
      
      const response = await api.post('/api/user/create', userData);
      console.log('‚úÖ User created successfully:', response);
      
      return {
        success: true,
        message: "Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error creating user:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫°o ng∆∞·ªùi d√πng: ${error.message}`);
    }
  },

  async updateUser(id, userData) {
    try {
      console.log('üîÑ Updating user:', id, userData);
      
      const response = await api.patch(`/api/user/update/${id}`, userData);
      console.log('‚úÖ User updated successfully:', response);
      
      return {
        success: true,
        message: "Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error updating user:', error);
      throw new Error(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng: ${error.message}`);
    }
  },

  async deleteUser(id) {
    try {
      console.log('üîÑ Deleting user:', id);
      
      const response = await api.delete(`/api/user/${id}`);
      console.log('‚úÖ User deleted successfully:', response);
      
      return {
        success: true,
        message: "Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error deleting user:', error);
      throw new Error(`Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng: ${error.message}`);
    }
  },

  // SECTION: Orders Management - Qu·∫£n l√Ω ƒë∆°n h√†ng
  async getOrders(page = 1, limit = 10) {
    try {
      console.log('üîÑ Loading orders from backend...');
      const response = await api.get(`/api/order?page=${page}&limit=${limit}`);
      console.log('üì¶ Orders response:', response);
      
      return {
        success: true,
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error loading orders:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng: ${error.message}`);
    }
  },

  async getOrderById(orderId) {
    try {
      console.log('üîÑ Getting order by ID:', orderId);
      
      const response = await api.get(`/api/order/${orderId}`);
      console.log('‚úÖ Order retrieved successfully:', response);
      
      return {
        success: true,
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error getting order:', error);
      throw new Error(`Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ƒë∆°n h√†ng: ${error.message}`);
    }
  },

  async createOrder(orderData) {
    try {
      console.log('üîÑ Creating order:', orderData);
      
      const response = await api.post('/api/order', orderData);
      console.log('‚úÖ Order created successfully:', response);
      
      return {
        success: true,
        message: "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error creating order:', error);
      throw new Error(`Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng: ${error.message}`);
    }
  },

  async updateOrder(orderId, orderData) {
    try {
      console.log('üîÑ Updating order:', orderId, orderData);
      
      const response = await api.put(`/api/order/${orderId}`, orderData);
      console.log('‚úÖ Order updated successfully:', response);
      
      return {
        success: true,
        message: "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error updating order:', error);
      throw new Error(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ƒë∆°n h√†ng: ${error.message}`);
    }
  },

  async updateOrderStatus(orderId, status) {
    try {
      console.log('üîÑ Updating order status:', orderId, status);
      
      const response = await api.put(`/api/order/${orderId}/status`, { status });
      console.log('‚úÖ Order status updated successfully:', response);
      
      return {
        success: true,
        message: "Tr·∫°ng th√°i ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error updating order status:', error);
      throw new Error(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng: ${error.message}`);
    }
  },

  async deleteOrder(orderId) {
    try {
      console.log('üîÑ Deleting order:', orderId);
      
      const response = await api.delete(`/api/order/${orderId}`);
      console.log('‚úÖ Order deleted successfully:', response);
      
      return {
        success: true,
        message: "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng",
        data: response
      };
    } catch (error) {
      console.error('‚ùå Error deleting order:', error);
      throw new Error(`Kh√¥ng th·ªÉ x√≥a ƒë∆°n h√†ng: ${error.message}`);
    }
  }
};
